@model List<ShowPostVM>
@{
    ViewData["Title"] = "LoadPosts";
    Layout = null;
}
<style>
    .three-dots {
        cursor: pointer;
    }
</style>

@foreach (var item in Model)
{
    <div class="tab-content p-0" id="@($"post{item.Id}")">
        <div class="tab-pane fade active show" id="profile-post">
            <ul class="timeline">
                <li>
                    <div class="timeline-time">
                        <span class="time">@item.DateCreated.ToString("HH:mm")</span>
                        <time class="timeago date" datetime="@item.DateCreated">
                        </time>
                        @*<span class="date">today</span>*@
                    </div>
                    <div class="timeline-icon">
                        <a href="javascript:;">&nbsp;</a>
                    </div>
                    <div class="timeline-body">
                        <div>
                            <div class="d-flex flex-column shadow rounded bg-white p-3 mb-3" >
                                <div class=" d-flex justify-content-between mb-2">
                                    <div class="d-flex">
                                        @if (item.ProfileImage != null)
                                        {
                                            <a asp-controller="UserProfile" asp-action="Index" asp-route-id="@item.AuthorId">
                                                <img src="data:image/*;base64,@(Convert.ToBase64String(item.ProfileImage))" class="rounded-circle border-dark slika" style="height: 60px; width: 60px; background-size: cover; background-position: center;">
                                            </a>
                                        }
                                        else
                                        {
                                            <a asp-controller="UserProfile" asp-action="Index" asp-route-id="@item.AuthorId">
                                                <img src="/avatar.png" class="rounded-circle border-dark slika" style="height: 60px; width: 60px; background-size: cover; background-position: center;">
                                            </a>
                                        }
                                        <div class="pl-2">
                                            <div class="font-weight-bold "><a class="text-primary" asp-controller="UserProfile" asp-action="Index" asp-route-id="@item.AuthorId">@item.AuthorName</a></div>
                                            <div class="text-secondary" style="font-size:.85em">
                                                @item.Date
                                            </div>
                                        </div>
                                    </div>

                                    <div style="position: relative">
                                        @if (item.IsMe)
                                        {
                                            @*<a onclick="EditPost(@item.Id)" ><i class="fas fa-ellipsis-h fa-lg text-secondary three-dots" data-toggle="modal" data-target="#exampleModal" ></i></a>*@
                                            <i class="fas fa-ellipsis-h fa-lg text-secondary three-dots" onclick="TogglePostMenu(@item.Id)"></i>
                                            <div class="post-menu shadow rounded bg-light" id="@($"postMenu{item.Id}")">
                                                <div class="text-secondary">Options</div>
                                                <hr style="width:100%; margin: .6em 0px"/>
                                                <div class="mb-1">
                                                    <button data-toggle="modal" data-target="#exampleModal" class="btn btn-warning w-100" onclick="EditPost(@item.Id)">Edit Post</button>
                                                </div>
                                                <div>
                                                    <button  class="btn btn-danger w-100" onclick="DeletePost(@item.Id)">Delete Post</button>
                                                </div>
                                            </div>

                                        }
                                    </div>
                                </div>

                                <div class="post-hobby">
                                    <p class="text-secondary">@item.Hobby</p>
                                </div>

                                <div class="post-text">
                                    <p>
                                        @item.Text
                                    </p>
                                </div>

                                <div class="d-flex justify-content-between text-secondary">
                                    <a>0 interests</a>
                                    <a>@item.Comments.Count() comments</a>
                                </div>
                                <hr style="width: 100%" />
                                <div class="d-flex">
                                    <button class="flex-grow-1 btn btn-light mr-2">
                                        <i class="far fa-handshake text-secondary fa-lg"></i>
                                        <span class="text-secondary">Interested</span>
                                    </button>

                                    <button class="flex-grow-1 btn btn-light" onclick="toggleCommentBox(@item.Id)">
                                        <i class="far fa-comment-alt text-secondary fa-lg"></i>
                                        <span>Comment</span>
                                    </button>
                                </div>

                                <!-- Comment Section -->
                                <div id="@($"commentSection{item.Id}")" class="mt-3 d-none">
                                    <div id="@($"commentsList{item.Id}")">
                                        @foreach (var c in item.Comments)
                                        {
                                            <div id="comment-@c.Id" class="border rounded p-2 mb-2 bg-light">
                                                <strong>@c.AuthorName:</strong>
                                                <p class="mb-0">@c.Text</p>
                                                <small class="text-muted">@c.DateCreated.ToString("g")</small>
                                            </div>
                                        }
                                    </div>

                                    <!-- Add New Comment -->
                                    <div class="d-flex mt-2">
                                        <input type="text" class="form-control mr-2" id="@($"newComment{item.Id}")" placeholder="Write a comment..." />
                                        <button class="btn btn-primary" onclick="addComment(@item.Id)">Post</button>
                                    </div>
                                </div>


                            </div>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </div>

}

<script>
    // ✅ Use global variable but prevent redeclaration
    window.commentConnection = window.commentConnection || null;

    $(document).ready(function () {
        $("time.timeago").timeago();

        // 🟢 Initialize SignalR connection only once
        if (!window.commentConnection) {
            window.commentConnection = new signalR.HubConnectionBuilder()
                .withUrl("/commentHub")
                .build();

            window.commentConnection
                .start()
                .then(() => {
                    console.log("✅ SignalR connected");

                    // Join all posts currently on the page
                    $(".tab-content").each(function () {
                        const postId = $(this).attr("id").replace("post", "");
                        window.commentConnection.invoke("JoinPostGroup", parseInt(postId));
                    });
                })
                .catch(err => console.error("SignalR connection error:", err));

            // 🧹 Remove any old handlers
            window.commentConnection.off("ReceiveComment");
            window.commentConnection.off("UpdateComment");
            window.commentConnection.off("DeleteComment");

            // 🟢 Receive comment
            window.commentConnection.on("ReceiveComment", (postId, authorName, text, dateCreated, commentId) => {
                appendComment(postId, authorName, text, dateCreated, commentId);
            });

            // 🟡 Update comment
            window.commentConnection.on("UpdateComment", (postId, commentId, text, dateCreated) => {
                const commentEl = $(`#comment-${commentId}`);
                if (commentEl.length) {
                    commentEl.find("p").text(text);
                    commentEl.find("small").text(new Date(dateCreated).toLocaleString());
                }
            });

            // 🔴 Delete comment
            window.commentConnection.on("DeleteComment", (postId, commentId) => {
                $(`#comment-${commentId}`).remove();
            });
        }
    });

    // ✅ Make functions globally available (not inside jQuery ready)
    function toggleCommentBox(postId) {
        const section = $(`#commentSection${postId}`);
        section.toggleClass("d-none");

        if (!section.hasClass("d-none")) {
            loadComments(postId);
        }
    }

    function loadComments(postId) {
        $.get(`/Comment/GetComments/${postId}`)
            .done(comments => {
                const list = $(`#commentsList${postId}`);
                list.empty();

                // Sort comments ascending by date
                comments.sort((a, b) => new Date(a.dateCreated) - new Date(b.dateCreated));

                comments.forEach(c => {
                    appendComment(postId, c.authorName || "Anonymous", c.text, c.dateCreated, c.id);
                });
            })
            .fail(() => console.error("❌ Failed to load comments."));
    }

    function appendComment(postId, authorName, text, dateCreated, id = null) {
        if (id && $(`#comment-${id}`).length > 0) return; // prevent duplicates

        const safeId = id ? `id="comment-${id}"` : "";
        const html = `
                <div ${safeId} class="border rounded p-2 mb-2 bg-light">
                    <strong>${authorName}:</strong>
                    <p class="mb-0">${text}</p>
                    <small class="text-muted">${new Date(dateCreated).toLocaleString()}</small>
                </div>
            `;
        $(`#commentsList${postId}`).append(html);
    }

    function addComment(postId) {
        const input = $(`#newComment${postId}`);
        const text = input.val().trim();
        if (!text) return alert("Please enter a comment.");

        $.post(`/Comment/AddComment`, { postId, text })
            .done(res => {
                if (res.success) {
                    input.val("");
                } else {
                    alert("Failed to add comment.");
                }
            })
            .fail(() => alert("❌ Failed to post comment."));
    }
</script>


